name: iOS VRT Tests

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.swift'
      - '**/*.xib'
      - '**/*.storyboard'
      - 'ios-app/**'
      - '.github/workflows/vrt-tests.yml'

jobs:
  vrt-tests:
    runs-on: macos-14
    timeout-minutes: 60
    env:
      SCHEME: ios-appTests
      DESTINATION: 'platform=iOS Simulator,name=iPhone 16,OS=18.6'
      SNAPSHOT_ARTIFACTS: ${{ github.workspace }}/snapshot-artifacts
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v3
      with:
        xcode-version: '16'

    - name: Resolve Package Dependencies
      run: |
        cd ios-app
        xcodebuild -resolvePackageDependencies -project ios-app.xcodeproj

    - name: Build and Test
      id: test
      continue-on-error: true
      run: |
        mkdir -p "$SNAPSHOT_ARTIFACTS"
        cd ios-app
        set -o pipefail && xcodebuild \
          -project ios-app.xcodeproj \
          -scheme "$SCHEME" \
          -destination "$DESTINATION" \
          -resultBundlePath ../TestResults.xcresult \
          test | xcpretty -r junit --output ../tests.xml

    - name: Upload snapshot artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: vrt-snapshots-${{ github.sha }}
        path: snapshot-artifacts
        retention-days: 30

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.sha }}
        path: TestResults.xcresult
        retention-days: 30

    - name: Comment on PR
      if: failure() && github.event_name == 'pull_request'
      uses: peter-evans/create-or-update-comment@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ### ğŸ“¸ VRT ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
          
          ã‚³ãƒŸãƒƒãƒˆ **${{ github.sha }}** ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å·®åˆ†ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          
          **[ğŸ”— ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**
          
          - `vrt-snapshots-${{ github.sha }}`: å·®åˆ†ç”»åƒã¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
          - `test-results-${{ github.sha }}`: è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœ
          
          ### ğŸ“‹ å¯¾å¿œæ–¹æ³•
          1. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å·®åˆ†ç”»åƒã‚’ç¢ºèª
          2. æ„å›³çš„ãªå¤‰æ›´ã®å ´åˆ: `record` ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ›´æ–°
          3. äºˆæœŸã—ãªã„å¤‰æ›´ã®å ´åˆ: ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦VRTãƒ†ã‚¹ãƒˆã‚’å†å®Ÿè¡Œ

    - name: Fail job on test failure
      if: steps.test.outcome == 'failure'
      run: exit 1